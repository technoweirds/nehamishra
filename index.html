<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Visualization (Per Person)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.js"
      integrity="sha512-L0Shl7nXXzIlBSUUPpxrokqq4ojqgZFQczTYlGjzONGTDAcLremjwaWv5A+EDLnxhQzY5xUZPWLOLqYRkY0Cbw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style>
        .card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .person-section {
            width: 100%;
            margin-bottom: 30px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
        }
        .person-card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        .person-card {
            width: calc(50% - 20px); /* Two cards per row for each person */
            min-width: 300px;
        }
        @media (max-width: 768px) {
            .person-card {
                width: 100%;
            }
        }
        .chart-canvas {
            width: 100%;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Expense Data Visualization (Per Person)</h1>
        <div id="visualization-container">
            </div>
    </div>

    <script>
        const googleSheetCsvUrl = 'http://docs.google.com/spreadsheets/d/e/2PACX-1vTiPzJHYnMki14fMCFiIPmP-RTZgIax8RJXP9urMO1PIxl4Z6nKwkHaYrkDpwXQQQZ8izsLOiq7Y1zt/pub?gid=126532432&single=true&output=csv';
        const corsProxyUrl = 'https://api.allorigins.win/raw?url=';
        const fetchUrl = corsProxyUrl + encodeURIComponent(googleSheetCsvUrl);
        const visualizationContainer = document.getElementById('visualization-container');

        fetch(fetchUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(csvData => {
                const lines = csvData.trim().split('\n');
                if (lines.length <= 1) {
                    visualizationContainer.innerHTML = '<p class="alert alert-warning">No data found.</p>';
                    return;
                }

                const headers = lines[0].split(',');
                const dataRows = lines.slice(1);

                const expenses = dataRows.map(row => {
                    const values = row.split(',');
                    const amountStr = values[3] ? values[3].replace(',', '') : '0';
                    const dateStr = values[1];
                    const parsedDate = new Date(dateStr);

                    return {
                        timestamp: new Date(values[0]),
                        date: parsedDate,
                        type: values[2],
                        amount: parseFloat(amountStr),
                        paymentMode: values[4],
                        remarks: values[5],
                        email: values[6]
                    };
                });

                // Group expenses by person
                const expensesByPerson = {};
                expenses.forEach(expense => {
                    if (!expensesByPerson[expense.email]) {
                        expensesByPerson[expense.email] = [];
                    }
                    expensesByPerson[expense.email].push(expense);
                });

                // Iterate through each person and create visualizations
                for (const personEmail in expensesByPerson) {
                    const personExpenses = expensesByPerson[personEmail];

                    const personSection = document.createElement('div');
                    personSection.classList.add('person-section');
                    personSection.innerHTML = `<h3>Expenses for ${personEmail}</h3><div class="person-card-container"></div>`;
                    visualizationContainer.appendChild(personSection);

                    const personCardContainer = personSection.querySelector('.person-card-container');

                    // Create Type-wise Spending Chart for the current person
                    const typeWiseSpending = {};
                    personExpenses.forEach(expense => {
                        typeWiseSpending[expense.type] = (typeWiseSpending[expense.type] || 0) + expense.amount;
                    });
                    const typeLabels = Object.keys(typeWiseSpending);
                    const typeData = Object.values(typeWiseSpending);
                    const typeCanvasId = `typeWiseSpendChart-${personEmail.replace(/[^a-zA-Z0-9]/g, '')}`;
                    const typeCard = document.createElement('div');
                    typeCard.classList.add('person-card', 'card', 'shadow-sm');
                    typeCard.innerHTML = `<div class="card-body"><h5 class="card-title">Spending by Type</h5><canvas id="${typeCanvasId}" class="chart-canvas"></canvas></div>`;
                    personCardContainer.appendChild(typeCard);
                    new Chart(document.getElementById(typeCanvasId).getContext('2d'), {
                        type: 'bar',
                        data: { labels: typeLabels, datasets: [{ label: 'Amount Spent', data: typeData, backgroundColor: 'rgba(255, 99, 132, 0.7)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 }] },
                        options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Amount' } } }, plugins: { legend: { display: false } } }
                    });

                    // Create Month-wise Spending Chart for the current person
                    const monthWiseSpending = {};
                    personExpenses.forEach(expense => {
                        const year = expense.date.getFullYear();
                        const month = String(expense.date.getMonth() + 1).padStart(2, '0');
                        const yearMonth = `${year}-${month}`;
                        monthWiseSpending[yearMonth] = (monthWiseSpending[yearMonth] || 0) + expense.amount;
                    });
                    const monthLabels = Object.keys(monthWiseSpending).sort();
                    const monthData = monthLabels.map(month => monthWiseSpending[month]);
                    const monthCanvasId = `monthWiseSpendChart-${personEmail.replace(/[^a-zA-Z0-9]/g, '')}`;
                    const monthCard = document.createElement('div');
                    monthCard.classList.add('person-card', 'card', 'shadow-sm');
                    monthCard.innerHTML = `<div class="card-body"><h5 class="card-title">Monthly Spending Trend</h5><canvas id="${monthCanvasId}" class="chart-canvas"></canvas></div>`;
                    personCardContainer.appendChild(monthCard);
                    new Chart(document.getElementById(monthCanvasId).getContext('2d'), {
                        type: 'line',
                        data: { labels: monthLabels, datasets: [{ label: 'Amount Spent', data: monthData, borderColor: 'rgba(75, 192, 192, 1)', fill: false, tension: 0.1 }] },
                        options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Amount' } }, x: { title: { display: true, text: 'Month-Year' } } }, plugins: { legend: { display: false } } }
                    });

                    // Create Payment Mode-wise Spending Chart for the current person
                    const paymentModeSpending = {};
                    personExpenses.forEach(expense => {
                        paymentModeSpending[expense.paymentMode] = (paymentModeSpending[expense.paymentMode] || 0) + expense.amount;
                    });
                    const paymentModeLabels = Object.keys(paymentModeSpending);
                    const paymentModeData = Object.values(paymentModeSpending);
                    const paymentModeCanvasId = `paymentModeSpendChart-${personEmail.replace(/[^a-zA-Z0-9]/g, '')}`;
                    const paymentModeCard = document.createElement('div');
                    paymentModeCard.classList.add('person-card', 'card', 'shadow-sm');
                    paymentModeCard.innerHTML = `<div class="card-body"><h5 class="card-title">Spending by Payment Mode</h5><canvas id="${paymentModeCanvasId}" class="chart-canvas"></canvas></div>`;
                    personCardContainer.appendChild(paymentModeCard);
                    const backgroundColors = ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'];
                    const borderColors = ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)'];
                    new Chart(document.getElementById(paymentModeCanvasId).getContext('2d'), {
                        type: 'pie',
                        data: { labels: paymentModeLabels, datasets: [{ label: 'Amount Spent', data: paymentModeData, backgroundColor: backgroundColors.slice(0, paymentModeLabels.length), borderColor: borderColors.slice(0, paymentModeLabels.length), borderWidth: 1 }] },
                        options: { plugins: { legend: { position: 'bottom' } } }
                    });
                }

            })
            .catch(error => {
                console.error('Error fetching and processing data:', error);
                visualizationContainer.innerHTML = `<p class="alert alert-danger">Error loading data: ${error.message}</p>`;
            });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
